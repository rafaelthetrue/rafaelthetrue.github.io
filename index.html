<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Entdecke in unserer Übersicht die nächsten Techno Raves und anstehende Events in der Nähe, egal ob Techno Raves heute, morgen oder am Wochenende im Ruhrgebiet und NRW.">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#f9f9f9">
  <title>Techno Raves 2025 (Termine, Events & Locations) - ravebro.de</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script defer data-domain="ravebro.de" src="https://plausible.io/js/script.pageview-props.tagged-events.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      padding: 0;
      margin: 0;
      background-color: #f9f9f9;
      color: #333;
      display: flex;
      flex-direction: column;
      height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    .header { max-width: 800px; margin: 0 auto; text-align: center; }
    h1 { color: #444; margin-top: 15px; margin-bottom: 0px; font-size: 24px; }
    h2 { color: #444; margin-top: 0px; margin-bottom: 0px; font-size: 10px; }

    .menu-icon-container { margin: 0 auto; text-align: right; position: relative; max-width: 800px; }
    .menu-icon { font-size: 24px; display: flex; justify-content: center; align-items: center; width: 24px; height: 24px; }
    .menu {
      position: absolute; top: 100%; right: 0; background-color: white;
      border: 1px solid #ddd; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none; flex-direction: column; z-index: 1000;
    }
    .menu.show { display: flex; }
    .menu a { padding: 10px 20px; text-decoration: none; color: #333; border-bottom: 1px solid #ddd; text-align: left; }
    .menu a:last-child { border-bottom: none; }
    .menu a:hover { background-color: #f4f4f4; }

    .search-container { margin: 10px 0; text-align: center; }
    .search-container input { width: 80%; max-width: 400px; padding: 10px; font-size: 16px; }

    .table-container {
      overflow-y: auto; border: 1px solid #ddd; max-width: 100%; margin: 0 auto;
      border-collapse: collapse; padding: 0; height: 90%; position: relative;
    }
    table { width: 100%; border-collapse: collapse; table-layout: auto; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; vertical-align: top; word-wrap: break-word; white-space: normal; }
    th { background-color: #f4f4f4; position: sticky; top: 0; z-index: 2; margin: 0; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr.past-event td { text-decoration: line-through; color: #888; }
    tr.past-event .date-cell span { color: #888; }
    .date-cell { text-align: center; white-space: nowrap; }
    .date-cell span { font-size: 13px; color: #333; font-family: Arial, sans-serif; display: block; margin-top: 0px; }

    table a:link, table a:visited, table a:hover, table a:active { color: black; }
    tr.past-event a:link, tr.past-event a:visited { color: #888; }
    tr.past-event a:hover, tr.past-event a:active { color: #666; text-decoration: none; }

    @media (max-width: 600px) {
      body { font-size: 14px; }
      h1 { font-size: 22px; }
      th, td { font-size: 12px; padding: 8px; }
      td:nth-child(4) { word-break: break-word; hyphens: auto; overflow-wrap: break-word; white-space: normal; min-width: 70px; max-width: 120px; }
    }

    .icon-bar {
      display: flex; justify-content: center; align-items: flex-end;
      max-width: 800px; margin: 10px auto; height: 40px; position: relative;
    }
    .icon-wrapper {
      position: absolute; bottom: 0; height: 100%;
      display: flex; justify-content: center; align-items: flex-end;
      z-index: 1500; /* >>> über Menü (1000) */
    }
    .icon-left  { left:  calc(50% - 90px); }
    .icon-right { right: calc(50% - 90px); }
    .icon-center { position: relative; }

    @media (max-width: 600px) {
      .icon-left  { left:  calc(50% - 90px); }
      .icon-right { right: calc(50% - 90px); }
    }

    .icon { width: 24px; height: 24px; color: #333; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0; margin: 0; }

    /* Statistik-Icon (3 vertikale Balken) */
    .stats-icon { display: flex; flex-direction: row; justify-content: center; align-items: flex-end; width: 24px; height: 24px; gap: 3px; transform: translateY(-4px); }
    .stats-icon .bar { width: 3px; background-color: #333; border-radius: 1px; }
    .stats-icon .bar1 { height: 6px; } .stats-icon .bar2 { height: 12px; } .stats-icon .bar3 { height: 9px; }

    .top-icon { display: flex; justify-content: center; width: 24px; height: 24px; }
    .trend-arrow { width: 24px; height: 24px; display: block; margin-top: 3px; pointer-events: none; } /* <<< WICHTIG */

    /* Popup-Styling */
    #statsPopup, #topRavesPopup {
      display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.4);
      z-index: 2000; justify-content: center; align-items: center;
    }
    #statsPopupInner, #topRavesPopupInner {
      position: relative; background-color: white; border: 1px solid #ccc; border-radius: 10px;
      padding: 30px; max-width: 90vw; max-height: 70vh; overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 16px; box-sizing: border-box;
    }
    #topRavesPopupInner { padding: 0 30px 30px 30px; }
    #topRavesPopupInner h2 { text-align: center; font-weight: bold; margin-top: 30px; margin-bottom: 15px; font-size: 16px; }

    #statsPopupClose, #topRavesPopupClose {
      position: absolute; top: 4px; right: 10px; font-size: 18px; cursor: pointer; color: #666; z-index: 10;
    }

    #topRavesPopupInner th, #statsPopupInner th { position: static !important; top: auto !important; }

    .info-icon {
      display: inline-block; width: 14px; height: 14px; font-size: 10px; line-height: 14px;
      border: 1px solid #666; border-radius: 50%; text-align: center; color: #666; transform: translateY(-3px);
    }
    .info-popup {
      display: none; font-size: 13px; color: #333; background: #f9f9f9; padding: 4px 4px !important;
      border: 1px solid #ccc; border-radius: 6px; margin: 0 auto 15px auto; text-align: center;
      max-width: 400px; width: 100%; box-sizing: border-box;
    }
    /* ——— Location: Silbentrennung erst ab 14 Zeichen ——— */
td.location-cell {
  word-break: keep-all;
  overflow-wrap: normal;
  hyphens: none;
  -webkit-hyphens: none;
}

td.location-cell .hyph-de {
  hyphens: auto;
  -webkit-hyphens: auto;
  word-break: normal;
  overflow-wrap: normal;
}

td.location-cell .nohyph {
  hyphens: none;
  -webkit-hyphens: none;
}
  </style>
</head>
<body>
  <div class="header">
    <h1>Techno Raves 2025</h1>
    <h2>Termine, Events & Locations in NRW</h2>
  </div>

  <div class="icon-bar">
    <div class="icon-wrapper icon-left">
      <div class="icon stats-icon" id="statsIcon" title="Statistik anzeigen">
        <div class="bar bar1"></div><div class="bar bar2"></div><div class="bar bar3"></div>
      </div>
    </div>

    <div class="icon-wrapper icon-center" id="menuWrapper">
      <div class="icon menu-icon" id="menuIcon">☰</div>
      <div class="menu" id="menu">
        <a href="#" id="refreshPage">Aktualisieren</a>
        <a href="statistik.html">Statistik</a>
        <a href="datenschutzerklaerung.html">Datenschutzerklärung</a>
        <a href="impressum.html">Impressum</a>
      </div>
    </div>

    <div class="icon-wrapper icon-right">
      <div class="icon top-icon" id="topRavesIcon" title="Top Raves">
        <svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="4,16 9,11 13,15 20,8" />
          <polyline points="17,8 20,8 20,11" />
        </svg>
      </div>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="search" placeholder="Suche Datum, Event, Location oder Stadt...">
  </div>

  <div class="table-container" id="tableContainer">
    <table id="eventTable">
      <thead><tr><th>Datum</th><th>Event (Link)</th><th>Location</th><th>Stadt</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Popup Overlay -->
  <div id="statsPopup">
    <div id="statsPopupInner">
      <div id="statsPopupClose">✕</div>
      <div id="statsPopupContent"></div>
    </div>
  </div>

  <!-- Zweites Popup Overlay -->
  <div id="topRavesPopup">
    <div id="topRavesPopupInner">
      <div id="topRavesPopupClose">✕</div>
      <div id="topRavesPopupContent"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const tableBody = document.querySelector("#eventTable tbody");
      const now = new Date();

      const excelFileUrl = "events.xlsx";

      async function loadExcelFile(url) {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        return XLSX.utils.sheet_to_json(worksheet);
      }

      function parseExcelDate(value) {
        if (typeof value === "number") {
          const excelEpoch = new Date(Date.UTC(1899, 11, 30));
          return new Date(excelEpoch.getTime() + value * 86400000);
        }
        return new Date(value);
      }

      function sortRows(rows) {
        return rows.sort((a, b) => {
          const dateA = new Date(a.Datum);
          const dateB = new Date(b.Datum);
          const cityA = a.Stadt?.toLowerCase() || "";
          const cityB = b.Stadt?.toLowerCase() || "";
          const eventA = a.Event?.toLowerCase() || "";
          const eventB = b.Event?.toLowerCase() || "";

          if (dateA - dateB !== 0) return dateA - dateB;
          if (cityA.localeCompare(cityB) !== 0) return cityA.localeCompare(cityB);
          return eventA.localeCompare(eventB);
        });
      }
      // ——— Hilfsfunktionen für Silbentrennung in "Location" ———
      function escapeHTML(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // Bis 12 Zeichen: keine Trennung. Ab 13 Zeichen: Silbentrennung (de).
      function hyphenateByThreshold(text, thresholdNoHyphen = 12) {
        if (text == null) return "";
        return String(text)
          .split(/(\s+)/) // Leerzeichen erhalten
          .map(tok => {
            if (!tok.trim()) return tok; // Leerraum durchreichen
            const safe = escapeHTML(tok);
            if (tok.length > thresholdNoHyphen) {
              return `<span class="hyph-de" lang="de">${safe}</span>`;
            }
            return `<span class="nohyph">${safe}</span>`;
          })
          .join("");
      }
      function renderTable(rows) {
        tableBody.innerHTML = "";
        rows.forEach(row => {
          if (!row.Datum || !row.Event || !row.Location || !row.Stadt) return;

          const dateObj = parseExcelDate(row.Datum);
          if (isNaN(dateObj)) return;

          const formattedDate = `${String(dateObj.getDate()).padStart(2,"0")}.${String(dateObj.getMonth()+1).padStart(2,"0")}`;
          const weekday = dateObj.toLocaleDateString("de-DE", { weekday: "short" }) + ".";

          const tr = document.createElement("tr");
          tr.setAttribute("data-date", dateObj.toISOString());

          const dateTd = document.createElement("td");
          dateTd.classList.add("date-cell");
          dateTd.innerHTML = `${formattedDate}<br><span>${weekday}</span>`;
          tr.appendChild(dateTd);

          const eventTd = document.createElement("td");
          const eventLink = document.createElement("a");
          eventLink.href = row.Link || "#";
          eventLink.target = "_blank";
          eventLink.textContent = row.Event;
          eventLink.addEventListener("click", () => {
            plausible("event-klick", { props: { name: row.Event, date: formattedDate, location: row.Location } });
          });
          eventTd.appendChild(eventLink);
          tr.appendChild(eventTd);

          const locationTd = document.createElement("td");
locationTd.classList.add("location-cell");
locationTd.innerHTML = hyphenateByThreshold(row.Location, 13); // ≤13 keine Trennung, ab 14 Silbentrennung
tr.appendChild(locationTd);
          const cityTd = document.createElement("td"); cityTd.textContent = row.Stadt; tr.appendChild(cityTd);

          const eventDate = new Date(dateObj); eventDate.setDate(eventDate.getDate()+1); eventDate.setHours(6,0,0,0);
          if (now > eventDate) { tr.classList.add("past-event"); }

          tableBody.appendChild(tr);
        });
      }

      function scrollToNextEvent() {
        const rows = Array.from(document.querySelectorAll("#eventTable tbody tr"));
        const tableContainer = document.getElementById("tableContainer");
        const headerHeight = document.querySelector("thead").offsetHeight;
        let nextEventRow = null;
        for (const row of rows) {
          const dataDate = row.getAttribute("data-date");
          if (dataDate) {
            const eventDate = new Date(dataDate);
            eventDate.setDate(eventDate.getDate()+1);
            eventDate.setHours(6,0,0,0);
            if (now <= eventDate) { nextEventRow = row; break; }
          }
        }
        if (nextEventRow) {
          const offsetTop = nextEventRow.offsetTop;
          const scrollPosition = offsetTop - headerHeight;
          tableContainer.scrollTo({ top: scrollPosition, behavior: "smooth" });
        }
      }

      function generateSchemaOrgMarkup(rows) {
        const head = document.querySelector("head");
        rows.forEach(row => {
          if (!row.Datum || !row.Event || !row.Location || !row.Stadt) return;
          const dateObj = parseExcelDate(row.Datum);
          if (isNaN(dateObj)) return;
          const eventMarkup = {
            "@context": "https://schema.org",
            "@type": "Event",
            "name": row.Event,
            "startDate": dateObj.toISOString(),
            "location": {
              "@type": "Place",
              "name": row.Location,
              "address": { "@type": "PostalAddress", "addressLocality": row.Stadt, "addressCountry": "DE" }
            },
            "url": row.Link || undefined
          };
          const script = document.createElement("script");
          script.type = "application/ld+json";
          script.textContent = JSON.stringify(eventMarkup, null, 2);
          head.appendChild(script);
        });
      }

      const allRows = await loadExcelFile(excelFileUrl);
      const currentYear = new Date().getFullYear();
      const filteredRows = allRows.filter(row => {
        const date = parseExcelDate(row.Datum);
        return !isNaN(date) && date.getFullYear() >= currentYear;
      });
      const sortedRows = sortRows(filteredRows);
      renderTable(sortedRows);
      scrollToNextEvent();
      generateSchemaOrgMarkup(sortedRows);

      // Kontextmenü/Textauswahl/Zoom
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('selectstart', e => e.preventDefault());
      document.addEventListener('gesturestart', e => e.preventDefault());
      document.addEventListener('gesturechange', e => e.preventDefault());
      document.addEventListener('gestureend', e => e.preventDefault());

      // Menü
      const menu = document.getElementById('menu');
      const menuIcon = document.getElementById('menuIcon');
      menuIcon.addEventListener('click', (ev) => { ev.stopPropagation(); menu.classList.toggle('show'); });
      document.addEventListener('click', e => {
        if (!menu.contains(e.target) && !menuIcon.contains(e.target)) { menu.classList.remove('show'); }
      });
      document.querySelectorAll('.menu a').forEach(link => link.addEventListener('click', () => { menu.classList.remove('show'); }));
      const refreshPage = document.getElementById('refreshPage');
      refreshPage.addEventListener('click', (e) => { e.preventDefault(); window.location.reload(true); });

      // Größen
      function adjustTableHeight() {
        const headerHeight = document.querySelector(".header").offsetHeight;
        const searchHeight = document.querySelector(".search-container").offsetHeight;
        const viewportHeight = window.innerHeight;
        const tableContainer = document.getElementById("tableContainer");
        tableContainer.style.height = `${0.86 * (viewportHeight - headerHeight - searchHeight)}px`;
      }
      adjustTableHeight();
      window.addEventListener('resize', adjustTableHeight);
      function adjustViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      window.addEventListener('load', adjustViewportHeight);
      window.addEventListener('resize', adjustViewportHeight);

      // Suche
      function searchTable() {
        const input = document.getElementById('search');
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('#eventTable tbody tr');
        rows.forEach(row => {
          const cells = Array.from(row.getElementsByTagName('td'));
          const match = cells.some(cell => cell.textContent.toLowerCase().includes(filter));
          row.style.display = match ? '' : 'none';
        });
      }
      document.getElementById('search').addEventListener('keyup', searchTable);

      // Popups
      const statsIcon = document.getElementById('statsIcon');
      const statsPopup = document.getElementById('statsPopup');
      const statsPopupClose = document.getElementById('statsPopupClose');
      statsPopupClose.addEventListener('click', () => { statsPopup.style.display = 'none'; });

      const topRavesIcon = document.getElementById("topRavesIcon");
      const topRavesPopup = document.getElementById("topRavesPopup");
      const topRavesPopupClose = document.getElementById("topRavesPopupClose");
      const topRavesPopupContent = document.getElementById("topRavesPopupContent");
      topRavesPopupClose.addEventListener("click", () => { topRavesPopup.style.display = "none"; });

      // HELPER: Tabellen im Popup befüllen
      function cleanLocationName(name) {
        return String(name)
          .replace(/\bclub\b/gi, "").replace(/club[-+]/gi, "").replace(/[-+]?club$/i, "")
          .replace(/\s+/g, " ").trim();
      }
      function extractLocations(locationStr) {
        if (!locationStr || /check event link/i.test(locationStr)) return [];
        return String(locationStr).split(/\s*(?:,|\+|&|\bund\b)\s*/i).map(cleanLocationName).filter(Boolean);
      }
      function countByField(data, field, limit, isLocation=false) {
        const counts = {};
        for (const row of data) {
          const values = isLocation ? extractLocations(row[field]) : [row[field]?.trim()];
          for (const v of values) { if (!v) continue; counts[v] = (counts[v]||0)+1; }
        }
        const grouped = {};
        for (const [name, count] of Object.entries(counts)) {
          if (!grouped[count]) grouped[count] = [];
          grouped[count].push(name);
        }
        return Object.entries(grouped)
          .sort((a,b)=>b[0]-a[0])
          .flatMap(([count,names])=>[[names.sort((a,b)=>a.localeCompare(b)).join(", "), Number(count)]])
          .slice(0, limit);
      }
      function fillTableInPopup(tableId, entries) {
        const tbody = document.querySelector(`#topRavesPopupContent #${tableId} tbody`);
        if (!tbody) return;
        tbody.innerHTML = "";
        let currentRank = 1, lastCount = null;
        entries.forEach(([names, count]) => {
          const isTie = count === lastCount;
          const rankDisplay = isTie ? "" : `${currentRank}.`;
          const row = document.createElement("tr");
          row.innerHTML = `<td>${rankDisplay}</td><td>${names}</td><td>${count}</td>`;
          tbody.appendChild(row);
          if (!isTie) currentRank++;
          lastCount = count;
        });
      }

      // Öffner für "Top Raves" – reagiert auf Tap & Click
function openTopRavesPopup(ev) {
  ev.preventDefault();
  ev.stopPropagation();

  (async () => {
    try {
      const resp = await fetch("statistik.html");
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      // Inhalt leeren
      topRavesPopupContent.innerHTML = "";

      // Abschnitt ab „Top 10 Raves“ sammeln (ohne Info-Popup)
      let collect = false;
      for (const el of doc.body.children) {
        if (el.tagName === "H2" || el.tagName === "H3") {
          if ((el.textContent || "").includes("Top 10 Raves")) {
            collect = true;
          }
        }
        if (collect) {
          if (el.id === "info-popup") continue; // <<< Hinweis-Popup überspringen
          topRavesPopupContent.appendChild(el.cloneNode(true)); // <<< container -> topRavesPopupContent
        }
      }

      if (!topRavesPopupContent.children.length) {
        // Falls nix gefunden wurde, kurze Meldung (optional)
        topRavesPopupContent.innerHTML = "<p>Top 10 Raves konnten nicht geladen werden.</p>";
      } else {
        // Optional: sicherstellen, dass kein Element mit id="info-popup" durchgeschlüpft ist
        const strayInfo = topRavesPopupContent.querySelector("#info-popup");
        if (strayInfo) strayInfo.remove();
      }

      // Jetzt erst anzeigen (kein „Lade …“ mehr)
      topRavesPopup.style.display = "flex";

      // Excel laden und Tabellen im Popup befüllen (falls vorhanden)
      try {
        const excelResponse = await fetch("events.xlsx");
        const arrayBuffer = await excelResponse.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);

        const now = new Date();
        const currentYear = now.getFullYear();
        const thisYear = data.filter(row => {
          const d = typeof row.Datum === "number"
            ? new Date(Date.UTC(1899, 11, 30) + row.Datum*86400000)
            : new Date(row.Datum);
          return !isNaN(d) && d.getFullYear() === currentYear;
        });

        const topCities = countByField(thisYear, "Stadt", 10);
        const topLocations = countByField(thisYear, "Location", 10, true);

        fillTableInPopup("topCities", topCities);
        fillTableInPopup("topLocations", topLocations);
      } catch (e) {
        console.warn("Excel konnte nicht geladen werden:", e);
      }
    } catch (err) {
      console.error("Fehler beim Laden der Top-Raves-Daten:", err);
      // Falls Fehler: Popup dennoch zeigen, aber ohne „Lade …“
      topRavesPopupContent.innerHTML = "<p>Fehler beim Laden. Bitte später erneut versuchen.</p>";
      topRavesPopup.style.display = "flex";
    }
  })();
}

// Pfeil-Icon aktivieren
topRavesIcon.addEventListener("click", openTopRavesPopup, { passive: false });

      // Klick außerhalb schließt Popups
      window.addEventListener("click", (e) => { if (e.target === topRavesPopup) topRavesPopup.style.display = "none"; });
      window.addEventListener("click", (e) => { if (e.target === statsPopup)   statsPopup.style.display   = "none"; });

      // Statistik-Popup
      statsIcon.addEventListener('click', async (ev) => {
        ev.preventDefault(); ev.stopPropagation();
        try {
          const response = await fetch("events.xlsx");
          const arrayBuffer = await response.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet);

          const now = new Date();
          const currentYear = now.getFullYear();
          const daysUntilSunday = (7 - now.getDay()) % 7;
          const endOfWeek = new Date(now); endOfWeek.setDate(now.getDate()+daysUntilSunday); endOfWeek.setHours(23,59,59,999);

          const thisYear = data.filter(row => {
            const date = typeof row.Datum === "number"
              ? new Date(Date.UTC(1899,11,30) + row.Datum*86400000)
              : new Date(row.Datum);
            return date.getFullYear() === currentYear;
          });

          const periodEvents = thisYear.filter(row => {
            const date = typeof row.Datum === "number"
              ? new Date(Date.UTC(1899,11,30) + row.Datum*86400000)
              : new Date(row.Datum);
            return date <= endOfWeek;
          });

          const past = periodEvents.filter(row => {
            const date = typeof row.Datum === "number"
              ? new Date(Date.UTC(1899,11,30) + row.Datum*86400000)
              : new Date(row.Datum);
            const end = new Date(date); end.setDate(end.getDate()+1); end.setHours(6,0,0,0);
            return now > end;
          });

          const future = thisYear.length - past.length;
          const startOfYear = new Date(currentYear, 0, 1);
          const daysInPeriod = Math.floor((endOfWeek - startOfYear) / (1000*60*60*24)) + 1;
          const avgPerDay = daysInPeriod > 0 ? periodEvents.length / daysInPeriod : 0;
          const avgPerWeek = Math.round(avgPerDay * 7);
          const avgPerMonth = Math.round(avgPerWeek * 4.345);

          const tableHTML = `
          <table style="margin:10px auto 30px auto;border-collapse:collapse;width:100%;max-width:400px;text-align:left;">
            <tr><th style="background-color:#f0f0f0;">Statistik</th><th style="background-color:#f0f0f0;">Raves</th></tr>
            <tr><td>Raves auf ravebro.de</td><td>${thisYear.length}</td></tr>
            <tr><td>- vergangene</td><td>${past.length}</td></tr>
            <tr><td>- bevorstehende</td><td>${future}</td></tr>
            <tr><td>Raves pro Woche</td><td>${avgPerWeek}</td></tr>
            <tr><td>Raves pro Monat</td><td>${avgPerMonth}</td></tr>
          </table>`;
          const statsPopupContent = document.getElementById("statsPopupContent");
          statsPopupContent.innerHTML = tableHTML;
          statsPopup.style.display = 'flex';
        } catch (error) {
          console.error("Fehler beim Laden der Statistikdaten:", error);
        }
      });
    });

    function toggleInfoPopup(event) {
      event.stopPropagation();
      const popup = document.getElementById("info-popup");
      if (popup) popup.style.display = (popup.style.display === "none" || !popup.style.display) ? "block" : "none";
    }
    document.addEventListener("click", () => {
      const popup = document.getElementById("info-popup");
      if (popup) popup.style.display = "none";
    });
  </script>
</body>
</html>